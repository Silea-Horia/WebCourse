<!DOCTYPE html>
<html>
    <head>
        <title>ecommerce</title>
        <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
        <link href="styles.css" rel="stylesheet" >
    </head>
    <body>
        <div id="cart-container">
            <button id="cart-button" onclick="setCartDisplay()">View cart</button>
            <table id="cart-table">
                <tr>
                    <th>Product Name</th>
                    <th>Amount</th>
                </tr>
            </table>
        </div>
        <div class="category-buttons"></div>
        <div id="product-list"></div>
        <div class="page-buttons">
            <ul>
                <button id="prev-button" onclick="previousPage()">Previous</button>
                <button id="next-button" onclick="nextPage()">Next</button>
            </ul>
        </div>
        <div class="action-buttons">
            <button id="add-button" onclick="navigateToCreate()">Create Product</button>
        </div>
        <div id="product-details">
            <form method="post" id="update-product-form">
                <input id="product-id-field" type="hidden" name="id"/>
                Name: <input id="product-name-field" type="text" name="pname"/>
                Price: <input id="product-price-field" type="text" name="price" />
                Category: <select id="category-options" name="category"></select>
                <input type="submit" />
            </form>
            <div id="form-message"></div>
            <button onclick="minimize()">Go back</button>
        </div>
    </body>
    <script>
        let page = 1;
        let currentCategory = "";
        let totalPages = 0;
        let shoppingCart = {};

        $(document).ready(function() {
            setCategoriesButtons();
            
            document.getElementById("prev-button").disabled = true;
            document.getElementById("next-button").disabled = true;

            document.getElementById("cart-table").style.visibility = "collapse";

            document.getElementById("product-details").style.display = "none";

            $("#update-product-form").on("submit", function(event) {
                event.preventDefault();

                let formData = $(this).serialize();
                let formMessage = $("#form-message");

                $.ajax({
                    type: "POST",
                    url: "updateProduct.php",
                    data: formData,
                    dataType: "json",
                    success: function(response) {
                        if (response.success) {
                            formMessage.html('<p style="color: green;">Product updated successfully!</p>');
                        } else {
                            formMessage.html('<p style="color: red;">Error: ' + response.error + '</p>');
                        }
                        populateCategory();
                        populateCart();
                    },
                    error: function(xhr, status, error) {
                        formMessage.html('<p style="color: red;">Error submitting form: ' + error + '</p>');
                    }
                });
            })
        });

        function setCategoriesButtons() {
            $.ajax({
                type: "GET",
                url: "getCategories.php",
                success: function(data, status) {
                    createCategoryList(data.categories);
                }
            });
        }

        function createCategoryList(categories) {
            let categoryContainer = document.getElementsByClassName("category-buttons")[0];

            for (let category of categories) {
                let button = document.createElement("button");
                button.textContent = category;
                button.onclick = function () { setCategory(category); };

                categoryContainer.appendChild(button);
            }
        }

        function setCategory(category) {
            console.log(category);
            
            currentCategory = category;
            page = 1;

            populateCategory();
        }

        function populateCategory() {
            document.getElementById("prev-button").disabled = (page == 1);
            document.getElementById("next-button").disabled = (page == totalPages);

            $.ajax({
                type: "GET",
                url: "getProducts.php",
                data: {"Category" : currentCategory, "Page" : page},
                success: function(data, status) {
                    totalPages = data.totalPages;
                    createProductList(data.products);
                }
            });
        }

        function createProductList(products) {
            const table = document.createElement("table");
            table.id = "product-table";

            for (let product of products) {
                let tableRow = document.createElement("tr");

                let productName = document.createElement("td");
                productName.textContent = product.name;
                productName.onclick = function() {
                    displayProductDetails(product);
                };
                productName.style.cursor = "help";
                tableRow.appendChild(productName);

                
                let price = document.createElement("td");
                price.textContent = product.price;
                price.style.cursor = "default";
                tableRow.appendChild(price);
                
                let addCell = document.createElement("td");
                let addButton = document.createElement("button");
                addButton.onclick = function(){ addProductToCartAndUpdate(product); };
                addButton.innerHTML = "add";
                addCell.appendChild(addButton);
                tableRow.appendChild(addCell);
                
                let deleteCell = document.createElement("td");
                let deleteButton = document.createElement("button");
                deleteButton.onclick = function(){ deleteProduct(product); };
                deleteButton.innerHTML = "delete";
                deleteCell.appendChild(deleteButton);
                tableRow.appendChild(deleteCell);

                table.appendChild(tableRow);
            }

            let productList = document.getElementById("product-list");
            productList.innerHTML = "";
            productList.appendChild(table);
            productList.style.marginLeft = "50px";
            productList.style.height = "100px";
        }

        function addProductToCartAndUpdate(product) {
            let productName = product.name;
            let price = parseFloat(product.price);

            console.log("added " + productName + " to cart");

            if (!(shoppingCart[productName])) {
                shoppingCart[productName] = [1, price];
            }
            else {
                shoppingCart[productName][0]++;
                shoppingCart[productName][1] += price;
            }

            console.log("new amount: " + shoppingCart[productName][0]);

            populateCart();
        }

        function previousPage() {
            if (page > 1) {
                page = page - 1;

                populateCategory();
            }
        }

        function nextPage() {
            if (page < totalPages) {
                page = page + 1;

                populateCategory();
            }
        }

        function setCartDisplay() {
            let cartTable = document.getElementById("cart-table");

            if (cartTable.style.visibility == "visible") {
                cartTable.style.visibility = "collapse";
                return;
            }

            populateCart();

        }

        function populateCart() {
            let cartTable = document.getElementById("cart-table");

            //console.log("populating cart... ");

            cartTable.style.visibility = "visible";
            cartTable.innerHTML = "<tr><th>Product Name</th><th>Amount</th><th>Price</th><th>Add</th><th>Remove</th></tr>";


            for (let [product, [amount, price]] of Object.entries(shoppingCart)) {
                console.log(product + " " + amount + " " + price);   

                let tableRow = document.createElement("tr");

                let tableProductName = document.createElement("td");
                tableProductName.textContent = product;

                let tableProductAmount = document.createElement("td");
                tableProductAmount.textContent = amount;

                let tableProductPrice = document.createElement("td");
                tableProductPrice.textContent = price;

                let addProduct = document.createElement("td");
                let addButton = document.createElement("button");
                addButton.textContent = "Add";
                addButton.onclick = function() { addProductToCartAndUpdate({'name':product, 'price':price}); };
                addProduct.appendChild(addButton);

                
                let removeProduct = document.createElement("td");
                let removeButton = document.createElement("button");
                removeButton.textContent = "Remove";
                removeButton.onclick = function() { removeFromCart(product); };
                removeProduct.appendChild(removeButton);

                tableRow.appendChild(tableProductName);
                tableRow.appendChild(tableProductAmount);
                tableRow.appendChild(tableProductPrice);
                tableRow.appendChild(addProduct);
                tableRow.appendChild(removeProduct);

                cartTable.appendChild(tableRow);
            }
        }
        
        function removeFromCart(productName) {
            console.log("remove " + productName + " from cart");

            if (!(shoppingCart[productName])) {
                console.error("Product is not in cart!");
                return;
            }

            shoppingCart[productName][0]--;
            shoppingCart[productName][1] -= shoppingCart[productName][1];


            if (shoppingCart[productName][0] == 0) {
                shoppingCart = Object.fromEntries(
                    Object.entries(shoppingCart).filter(([key]) => key != productName)
                );
            }

            console.log("new amount: " + shoppingCart[productName]);

            populateCart();
        }

        function navigateToCreate() {
            window.location.href = "create.html";
        }

        function deleteProduct(product) {
            console.log("deleting " + product);
            $.ajax({
                type: "GET",
                url: "deleteProduct.php",
                data: {"Id" : product.id},
                success: function(data, status) {
                    populateCategory();
                }
            });
        }

        function minimize() {
            document.getElementById("product-details").style.display = "none";
            $("#form-message").html("");
            console.log("minimizing");
        }

        function displayProductDetails(product) {
            console.log("displaying " + product.name);
            document.getElementById("product-details").style.display = "inline";
            document.getElementById("product-id-field").value = product.id;
            document.getElementById("product-name-field").value = product.name;
            document.getElementById("product-price-field").value = product.price;
            populateCategoryOptions();
            document.getElementById("category-options").value = product.category;
        }

        function populateCategoryOptions() {
            $.ajax({
                type: "GET",
                url: "getCategories.php",
                success: function(data, status) {
                    let categories = data.categories;

                    let categoryOptions = document.getElementById("category-options");

                    for (let category of categories) {
                        let option = document.createElement("option");
                        option.textContent = category;

                        categoryOptions.appendChild(option);
                    }
                }
            });
        }

    </script>
</html>